<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Réservation Express</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMV827TuPmnJbpQMA7v57UPDTHei3Q_gw&libraries=places"></script>

  <style>
    body { background:#1A1A1A; font-family:sans-serif; color:#FFF; padding:20px; }
    .pac-container{background-color:#262626!important;color:#CCC!important;border-radius:8px;border:1px solid #333;font-family:sans-serif;}
    .pac-item{color:#CCC!important;padding:8px 12px;}
    .pac-item:hover{background-color:#333!important;}
    .pac-icon{filter: invert(100%) brightness(80%);}
    .pac-item,.pac-item-query,.pac-item span{color:#FFF!important;}
    input[type="date"],input[type="time"],input[type="text"]{color-scheme:dark;background:#262626;color:#FFF;width:100%;margin-top:8px;padding:10px 15px;border-radius:8px;border:none;box-sizing:border-box;}
    ::-webkit-calendar-picker-indicator{filter: invert(1); cursor:pointer;}
    .label-with-icon{display:flex;align-items:center;gap:5px;}
    .icon-svg{width:20px;height:20px;vertical-align:middle;fill:currentColor;}
    .preset-btn{flex:1;font-size:12px;padding:6px;text-align:center;background:#262626;color:#FFF;border:1px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;transition:background .3s;}
    .preset-btn:hover{background:#333;}
    .container{background:#1A1A1A;border-radius:12px;padding:30px;max-width:1100px;margin:auto;box-sizing:border-box;}
    .row{display:flex;gap:30px;}
    .card{background-color:#262626;border-radius:12px;padding:25px;text-align:center;margin-top:25px;}
    .btn-primary{background-color:#007bff;color:#FFF;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;}
    .btn-primary[disabled]{background:#777;color:#CCC;opacity:.6;cursor:not-allowed;}
    /* Confirmation */
    #confirmation{display:none;max-width:900px;margin:40px auto;background:#111;border:1px solid #333;border-radius:12px;padding:30px;}
    #confirmation h2{margin-top:0}
    .recap{margin-top:15px;background:#1f1f1f;border-radius:10px;padding:16px;line-height:1.6}
    .recap b{color:#ddd}
  </style>
</head>

<body>

<div id="app" class="container">
  <div style="margin-bottom:20px;">
    <h2 style="font-size:22px;">Réservation Express</h2>
  </div>

  <div class="row">
    <div style="flex:1;">
      <label class="label-with-icon">Lieu de départ</label>
      <input id="autocomplete_depart" placeholder="Entrez votre lieu de départ" type="text">

      <div style="display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;">
        <button class="preset-btn" data-input="autocomplete_depart" data-adresse="18 Rue de Dunkerque, 75010 Paris">Gare du Nord</button>
        <button class="preset-btn" data-input="autocomplete_depart" data-adresse="17 Boulevard de Vaugirard, 75015 Paris">Montparnasse</button>
        <button class="preset-btn" data-input="autocomplete_depart" data-adresse="Place Louis-Armand, 75012 Paris">Gare de Lyon</button>
        <button class="preset-btn" data-input="autocomplete_depart" data-adresse="Aéroport Charles de Gaulle, Roissy-en-France">CDG</button>
        <button class="preset-btn" data-input="autocomplete_depart" data-adresse="Aéroport d'Orly, 94390 Orly">Orly</button>
      </div>

      <label style="display:block;margin-top:20px;">Date
        <input id="date" type="date" onclick="this.showPicker()" placeholder="Date">
      </label>
    </div>

    <div style="flex:1;">
      <label class="label-with-icon">Destination</label>
      <input id="autocomplete_destination" placeholder="Entrez votre destination" type="text">

      <div style="display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;">
        <button class="preset-btn" data-input="autocomplete_destination" data-adresse="18 Rue de Dunkerque, 75010 Paris">Gare du Nord</button>
        <button class="preset-btn" data-input="autocomplete_destination" data-adresse="17 Boulevard de Vaugirard, 75015 Paris">Montparnasse</button>
        <button class="preset-btn" data-input="autocomplete_destination" data-adresse="Place Louis-Armand, 75012 Paris">Gare de Lyon</button>
        <button class="preset-btn" data-input="autocomplete_destination" data-adresse="Aéroport Charles de Gaulle, Roissy-en-France">CDG</button>
        <button class="preset-btn" data-input="autocomplete_destination" data-adresse="Aéroport d'Orly, 94390 Orly">Orly</button>
      </div>

      <label style="display:block;margin-top:20px;">Heure
        <input id="heure" type="time" onclick="this.showPicker()" placeholder="Heure">
      </label>
    </div>
  </div>

  <div class="card">
    <img src="https://ik.imagekit.io/lakolo/eyJidWNrZXQiOiJkYXRhay1jZG4teHkiLCJlZGl0cyI6e30sImtleSI6ImNvbmZpZ3VyYXRvci1pbWdzL2NhcnMvZnIvODAwL1RPWU9UQS9QUk9BQ0UtVkVSU08tRUxFQ1RSSUMvNDg3NThfTU9OT1NQQUNFLTUtUE9SVEVTL25vaXItcGVybGEtbmVyYS1tZXRhbGxpc2UucG5nIn0=.png?updatedAt=1746260324316" alt="Voiture sélectionnée" style="width:250px;margin:auto;">
    <h3 style="margin-top:15px;">TOYOTA PROACE</h3>
    <div style="color:#AAA;">Passagers : 9</div>
  </div>

  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:25px;gap:15px;flex-wrap:wrap;">
    <!-- Téléphone -->
    <div style="display:flex;align-items:center;gap:8px;">
      <img src="https://ik.imagekit.io/lakolo/pngwing.com%20(6).png?updatedAt=1748077033496" alt="Téléphone" style="width:24px;height:24px;">
      <input type="tel" id="telephone" placeholder="Numéro de téléphone" style="background:#262626;color:#FFF;padding:10px 15px;border:none;border-radius:8px;width:200px;">
    </div>

    <!-- Personnes -->
    <div style="display:flex;align-items:center;font-size:16px;gap:8px;">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 256 256" fill="#FFF">
        <path d="M117.25 157.92a60 60 0 1 0-66.5 0a95.83 95.83 0 0 0-47.22 37.71a8 8 0 1 0 13.4 8.74a80 80 0 0 1 134.14 0a8 8 0 0 0 13.4-8.74a95.83 95.83 0 0 0-47.22-37.71M40 108a44 44 0 1 1 44 44a44.05 44.05 0 0 1-44-44m210.14 98.7a8 8 0 0 1-11.07-2.33A79.83 79.83 0 0 0 172 168a8 8 0 0 1 0-16a44 44 0 1 0-16.34-84.87a8 8 0 1 1-5.94-14.85a60 60 0 0 1 55.53 105.64a95.83 95.83 0 0 1 47.22 37.71a8 8 0 0 1-2.33 11.07"/>
      </svg>
      <button id="btn-moins" style="margin:0 10px;width:30px;height:30px;border-radius:50%;border:none;background:#262626;color:#FFF;">–</button>
      <span id="nombre-personnes">1</span>
      <button id="btn-plus" style="margin:0 10px;width:30px;height:30px;border-radius:50%;border:none;background:#262626;color:#FFF;">+</button>
    </div>

    <!-- Prix + bouton -->
    <div style="display:flex;align-items:center;gap:10px;">
      <div id="prixEstime" style="color:#FFF;font-weight:bold;background-color:#262626;padding:10px 15px;border-radius:6px;display:none;"></div>
      <button id="btn-reserver" disabled class="btn-primary">RÉSERVER</button>
    </div>
  </div>
</div>

<!-- Zone de confirmation -->
<div id="confirmation">
  <h2>✅ Réservation confirmée</h2>
  <p>Merci ! Nous avons bien reçu votre demande. Un email de confirmation vous a été envoyé.</p>
  <div class="recap" id="recapitulatif"></div>
  <p style="margin-top:16px;">Si vous souhaitez modifier ou annuler, répondez simplement à l’email reçu.</p>
</div>

<script>
  let autocompleteDepart, autocompleteDestination;

  function initAutocomplete() {
    const options = { types: ['geocode'], componentRestrictions: { country: 'fr' } };
    autocompleteDepart = new google.maps.places.Autocomplete(document.getElementById('autocomplete_depart'), options);
    autocompleteDestination = new google.maps.places.Autocomplete(document.getElementById('autocomplete_destination'), options);

    autocompleteDepart.addListener('place_changed', () => { estimerPrix(); verifierFormulaire(); });
    autocompleteDestination.addListener('place_changed', () => { estimerPrix(); verifierFormulaire(); });
  }

  function verifierFormulaire() {
    const depart = document.getElementById('autocomplete_depart').value.trim();
    const destination = document.getElementById('autocomplete_destination').value.trim();
    const date = document.getElementById('date').value;
    const heure = document.getElementById('heure').value;
    const telephone = document.getElementById('telephone').value.trim();
    const prixEstimeText = document.getElementById('prixEstime').textContent;

    const formulaireComplet = depart && destination && date && heure && telephone && prixEstimeText.includes("Prix");
    const btnReserver = document.getElementById('btn-reserver');

    btnReserver.disabled = !formulaireComplet;
    btnReserver.setAttribute('aria-disabled', !formulaireComplet);
  }

  function estimerPrix() {
    const depart = document.getElementById('autocomplete_depart').value.trim();
    const destination = document.getElementById('autocomplete_destination').value.trim();
    const prixEstime = document.getElementById('prixEstime');

    if (!depart || !destination) {
      prixEstime.textContent = "Veuillez saisir les lieux de départ et de destination.";
      prixEstime.style.display = "block";
      verifierFormulaire();
      return;
    }

    const directionsService = new google.maps.DirectionsService();
    directionsService.route({
      origin: depart,
      destination: destination,
      travelMode: google.maps.TravelMode.DRIVING,
    }, (response, status) => {
      if (status === 'OK') {
        const distanceEnMetres = response.routes[0].legs[0].distance.value;
        const distanceEnKm = distanceEnMetres / 1000;
        let prixTotal = distanceEnKm < 4 ? 10 : distanceEnKm * 2.5;
        prixEstime.textContent = `Distance : ${distanceEnKm.toFixed(1)} km | Prix : ${prixTotal.toFixed(2)} €`;
        prixEstime.style.display = "block";
      } else {
        prixEstime.textContent = "Erreur lors du calcul";
        prixEstime.style.display = "block";
      }
      verifierFormulaire();
    });
  }

  function formatDateFR(isoDate) {
    try {
      const d = new Date(isoDate + "T00:00:00");
      return d.toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    } catch(e) { return isoDate; }
  }

  window.addEventListener('load', () => {
    emailjs.init("yx7ldLiDmVC_uNq1N"); // Votre public key EmailJS
    initAutocomplete();

    ['autocomplete_depart', 'autocomplete_destination'].forEach(id => {
      document.getElementById(id).addEventListener('input', estimerPrix);
    });

    ['autocomplete_depart','autocomplete_destination','telephone'].forEach(id => {
      document.getElementById(id).addEventListener('input', verifierFormulaire);
    });

    document.getElementById('date').addEventListener('change', verifierFormulaire);
    document.getElementById('heure').addEventListener('change', verifierFormulaire);

    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', (event) => {
        const adresse = event.currentTarget.getAttribute('data-adresse');
        const inputId = event.currentTarget.getAttribute('data-input');
        document.getElementById(inputId).value = adresse;
        estimerPrix();
        verifierFormulaire();
      });
    });

    let nombrePersonnes = 1;
    const affichagePersonnes = document.getElementById('nombre-personnes');

    document.getElementById('btn-moins').addEventListener('click', () => {
      if (nombrePersonnes > 1) {
        nombrePersonnes--;
        affichagePersonnes.textContent = nombrePersonnes;
      }
    });

    document.getElementById('btn-plus').addEventListener('click', () => {
      if (nombrePersonnes < 9) {
        nombrePersonnes++;
        affichagePersonnes.textContent = nombrePersonnes;
      }
    });

    document.getElementById('btn-reserver').addEventListener('click', async () => {
      const btn = document.getElementById('btn-reserver');
      btn.disabled = true; // éviter les doubles clics
      btn.textContent = "Envoi en cours...";

      const prixEstimeText = document.getElementById('prixEstime').textContent;
      const prixCapture = (prixEstimeText.match(/Prix\s*:\s*([\d.,]+)/) || [null, ""])[1];

      const reservationData = {
        lieu_depart: document.getElementById('autocomplete_depart').value,
        lieu_arrivee: document.getElementById('autocomplete_destination').value,
        date: document.getElementById('date').value,
        heure: document.getElementById('heure').value,
        telephone: document.getElementById('telephone').value,
        prix: prixEstimeText,
        nombre_personnes: nombrePersonnes
      };

      try {
        await emailjs.send("service_8m9y4b7", "template_jjf7ayv", reservationData);

        // Afficher confirmation locale (pas de Stripe)
        const recapHtml = `
          <div><b>Départ :</b> ${reservationData.lieu_depart}</div>
          <div><b>Destination :</b> ${reservationData.lieu_arrivee}</div>
          <div><b>Date :</b> ${formatDateFR(reservationData.date)}</div>
          <div><b>Heure :</b> ${reservationData.heure}</div>
          <div><b>Téléphone :</b> ${reservationData.telephone}</div>
          <div><b>Personnes :</b> ${reservationData.nombre_personnes}</div>
          <div><b>Tarif estimé :</b> ${prixCapture ? prixCapture.replace('.', ',') + ' €' : reservationData.prix}</div>
        `;
        document.getElementById('recapitulatif').innerHTML = recapHtml;

        // Masquer l'app et montrer la confirmation
        document.getElementById('app').style.display = 'none';
        document.getElementById('confirmation').style.display = 'block';

      } catch (err) {
        alert("❌ Erreur lors de l'envoi de l'email. Merci de réessayer.");
        console.error(err);
        btn.disabled = false;
        btn.textContent = "RÉSERVER";
      }
    });

    verifierFormulaire();  // vérification initiale
  });
</script>

</body>
</html>
