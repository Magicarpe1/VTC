<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Réservation Express</title>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAMV827TuPmnJbpQMA7v57UPDTHei3Q_gw&libraries=places"></script>

  <style>
    body { background:#1A1A1A; font-family:sans-serif; color:#FFF; padding:20px; }
    .pac-container{background-color:#262626!important;color:#CCC!important;border-radius:8px;border:1px solid #333;font-family:sans-serif;}
    .pac-item{color:#CCC!important;padding:8px 12px;}
    .pac-item:hover{background-color:#333!important;}
    .pac-icon{filter: invert(100%) brightness(80%);}
    .pac-item,.pac-item-query,.pac-item span{color:#FFF!important;}
    input[type="date"],input[type="time"],input[type="text"],input[type="tel"]{
      color-scheme:dark;background:#262626;color:#FFF;width:100%;margin-top:8px;padding:10px 15px;
      border-radius:8px;border:none;box-sizing:border-box;transition:box-shadow .2s, outline .2s;
    }
    ::-webkit-calendar-picker-indicator{filter: invert(1); cursor:pointer;}
    .label-with-icon{display:flex;align-items:center;gap:5px;}
    .preset-btn{flex:1;font-size:12px;padding:6px;text-align:center;background:#262626;color:#FFF;border:1px solid rgba(255,255,255,0.1);border-radius:8px;cursor:pointer;transition:background .3s;}
    .preset-btn:hover{background:#333;}
    .container{background:#1A1A1A;border-radius:12px;padding:30px;max-width:1100px;margin:auto;box-sizing:border-box;}
    .row{display:flex;gap:30px;flex-wrap:wrap;}
    .card{background-color:#262626;border-radius:12px;padding:25px;text-align:center;margin-top:25px;}
    .btn-primary{background-color:#007bff;color:#FFF;border:none;padding:12px 20px;border-radius:6px;cursor:pointer;transition:transform .15s, box-shadow .15s;}
    .btn-primary[disabled]{background:#777;color:#CCC;opacity:.6;cursor:not-allowed;}

    /* Confirmation */
    #confirmation{display:none;max-width:900px;margin:40px auto;background:#111;border:1px solid #333;border-radius:12px;padding:30px;}
    #confirmation h2{margin-top:0}
    .recap{margin-top:15px;background:#1f1f1f;border-radius:10px;padding:16px;line-height:1.6}
    .recap b{color:#ddd}

    /* PMR */
    .pmr-toggle {display:inline-flex;align-items:center;gap:8px;background:#262626;color:#fff;border:1px solid rgba(255,255,255,.15);padding:10px 14px;border-radius:8px;cursor:pointer;user-select:none;transition:background .2s, box-shadow .2s, transform .1s;}
    .pmr-toggle.active {background:#2f2f2f;box-shadow:0 0 0 2px rgba(255,204,0,.25) inset;color:#ffcc00;}

    /* Ligne des actions : prix + bouton (nowrap) */
    .bar {display:flex;align-items:center;gap:15px;flex-wrap:nowrap}
    #prixEstime{
      color:#FFF;font-weight:bold;background-color:#262626;padding:10px 15px;border-radius:6px;display:none;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;min-width:0;flex:1;
    }

    /* Guard au-dessus du bouton quand disabled (pour capter le clic) */
    .btn-wrap{position:relative;display:inline-block}
    #btn-guard{position:absolute;inset:0;border-radius:6px;display:none}
    .btn-primary[disabled] + #btn-guard{display:block;cursor:not-allowed}

    /* Feedback visuel simple */
    .invalid{outline:2px solid #ff5757; box-shadow:0 0 0 3px rgba(255,87,87,.25);}
    @keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
    .shake{animation:shake .35s linear}

    /* Conteneur des 3 blocs (tel | personnes+pmr | actions) */
    .controls-row{display:flex;align-items:center;justify-content:space-between;gap:15px;flex-wrap:nowrap}
    @media (max-width: 720px){
      .controls-row{flex-wrap:wrap}
      .bar{flex-wrap:wrap}
      #prixEstime{flex:unset;width:100%}
    }
  </style>
</head>

<body>

<div id="app" class="container">
  <div style="margin-bottom:20px;">
    <h2 style="font-size:22px;">Réservation Express</h2>
  </div>

  <div class="row">
    <div style="flex:1;min-width:260px;">
      <label class="label-with-icon">Lieu de départ</label>
      <input id="autocomplete_depart" placeholder="Entrez votre lieu de départ" type="text">

      <div style="display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;">
        <button class="preset-btn" data-input="autocomplete_depart" data-adresse="18 Rue de Dunkerque, 75010 Paris">Gare du Nord</button>
        <button class="preset-btn" data-input="autocomplete_depart" data-adresse="17 Boulevard de Vaugirard, 75015 Paris">Montparnasse</button>
        <button class="preset-btn" data-input="autocomplete_depart" data-adresse="Place Louis-Armand, 75012 Paris">Gare de Lyon</button>
        <button class="preset-btn" data-input="autocomplete_depart" data-adresse="Aéroport Charles de Gaulle, Roissy-en-France">CDG</button>
        <button class="preset-btn" data-input="autocomplete_depart" data-adresse="Aéroport d'Orly, 94390 Orly">Orly</button>
      </div>

      <label style="display:block;margin-top:20px;">Date
        <input id="date" type="date" onclick="this.showPicker()" placeholder="Date">
      </label>
    </div>

    <div style="flex:1;min-width:260px;">
      <label class="label-with-icon">Destination</label>
      <input id="autocomplete_destination" placeholder="Entrez votre destination" type="text">

      <div style="display:flex;gap:5px;margin-top:8px;flex-wrap:wrap;">
        <button class="preset-btn" data-input="autocomplete_destination" data-adresse="18 Rue de Dunkerque, 75010 Paris">Gare du Nord</button>
        <button class="preset-btn" data-input="autocomplete_destination" data-adresse="17 Boulevard de Vaugirard, 75015 Paris">Montparnasse</button>
        <button class="preset-btn" data-input="autocomplete_destination" data-adresse="Place Louis-Armand, 75012 Paris">Gare de Lyon</button>
        <button class="preset-btn" data-input="autocomplete_destination" data-adresse="Aéroport Charles de Gaulle, Roissy-en-France">CDG</button>
        <button class="preset-btn" data-input="autocomplete_destination" data-adresse="Aéroport d'Orly, 94390 Orly">Orly</button>
      </div>

      <label style="display:block;margin-top:20px;">Heure
        <input id="heure" type="time" onclick="this.showPicker()" placeholder="Heure">
      </label>
    </div>
  </div>

  <div class="card">
    <img src="https://ik.imagekit.io/lakolo/eyJidWNrZXQiOiJkYXRhay1jZG4teHkiLCJlZGl0cyI6e30sImtleSI6ImNvbmZpZ3VyYXRvci1pbWdzL2NhcnMvZnIvODAwL1RPWU9UQS9QUk9BQ0UtVkVSU08tRUxFQ1RSSUMvNDg3NThfTU9OT1NQQUNFLTUtUE9SVEVTL25vaXItcGVybGEtbmVyYS1tZXRhbGxpc2UucG5nIn0=.png?updatedAt=1746260324316" alt="Voiture sélectionnée" style="width:250px;margin:auto;">
    <h3 style="margin-top:15px;">TOYOTA PROACE</h3>
    <div style="color:#AAA;">Passagers : 9</div>
  </div>

  <!-- Ligne: téléphone | personnes+PMR | prix + bouton -->
  <div class="controls-row" style="margin-top:25px;">
    <!-- Téléphone -->
    <div style="display:flex;align-items:center;gap:8px;">
      <img src="https://ik.imagekit.io/lakolo/pngwing.com%20(6).png?updatedAt=1748077033496" alt="Téléphone" style="width:24px;height:24px;">
      <input type="tel" id="telephone" placeholder="Numéro de téléphone" style="background:#262626;color:#FFF;padding:10px 15px;border:none;border-radius:8px;width:200px;">
    </div>

    <!-- Personnes + PMR -->
    <div style="display:flex;align-items:center;font-size:16px;gap:12px;flex-shrink:0;">
      <div style="display:flex;align-items:center;gap:8px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 256 256" fill="#FFF">
          <path d="M117.25 157.92a60 60 0 1 0-66.5 0a95.83 95.83 0 0 0-47.22 37.71a8 8 0 1 0 13.4 8.74a80 80 0 0 1 134.14 0a8 8 0 0 0 13.4-8.74a95.83 95.83 0 0 0-47.22-37.71M40 108a44 44 0 1 1 44 44a44.05 44.05 0 0 1-44-44m210.14 98.7a8 8 0 0 1-11.07-2.33A79.83 79.83 0 0 0 172 168a8 8 0 0 1 0-16a44 44 0 1 0-16.34-84.87a8 8 0 1 1-5.94-14.85a60 60 0 0 1 55.53 105.64a95.83 95.83 0 0 1 47.22 37.71a8 8 0 0 1-2.33 11.07"/>
        </svg>
        <button id="btn-moins" style="margin:0 10px;width:30px;height:30px;border-radius:50%;border:none;background:#262626;color:#FFF;">–</button>
        <span id="nombre-personnes">1</span>
        <button id="btn-plus" style="margin:0 10px;width:30px;height:30px;border-radius:50%;border:none;background:#262626;color:#FFF;">+</button>
      </div>
      <button id="pmr-btn" class="pmr-toggle" type="button" aria-pressed="false" title="Supplément PMR +10€">♿ PMR</button>
    </div>

    <!-- Prix + bouton -->
    <div class="bar" style="flex:1;">
      <div id="prixEstime"></div>
      <div class="btn-wrap" style="flex-shrink:0;">
        <button id="btn-reserver" disabled class="btn-primary">RÉSERVER</button>
        <div id="btn-guard" aria-hidden="true"></div>
      </div>
    </div>
  </div>
</div>

<!-- Zone de confirmation -->
<div id="confirmation">
  <h2>✅ Réservation confirmée</h2>
  <p>Merci ! Nous avons bien reçu votre demande.</p>
  <div class="recap" id="recapitulatif"></div>
  <p style="margin-top:16px;">L’un de nos chauffeurs vous contactera très prochainement pour confirmer votre trajet.</p>
</div>

<script>
  let autocompleteDepart, autocompleteDestination;
  let pmrActif = false;

  const IDF_DEPS = new Set(['75','77','78','91','92','93','94','95']);
  const IDF_BBOX = { minLat:48.0, maxLat:49.5, minLng:1.4, maxLng:3.6 };

  function initAutocomplete() {
    const options = { types: ['geocode'], componentRestrictions: { country: 'fr' } };
    autocompleteDepart = new google.maps.places.Autocomplete(document.getElementById('autocomplete_depart'), options);
    autocompleteDestination = new google.maps.places.Autocomplete(document.getElementById('autocomplete_destination'), options);
    autocompleteDepart.addListener('place_changed', () => { estimerPrix(); verifierFormulaire(); });
    autocompleteDestination.addListener('place_changed', () => { estimerPrix(); verifierFormulaire(); });
  }

  function cpFromComponents(components){
    const cpComp = (components||[]).find(c => c.types.includes('postal_code'));
    return cpComp ? cpComp.long_name : null;
  }
  function isInIDFFromCP(cp){ if(!cp || cp.length<2) return null; return IDF_DEPS.has(cp.substring(0,2)); }
  function inBbox(latlng){ return latlng.lat()>=IDF_BBOX.minLat && latlng.lat()<=IDF_BBOX.maxLat && latlng.lng()>=IDF_BBOX.minLng && latlng.lng()<=IDF_BBOX.maxLng; }
  function isParisFromCP(cp){ return cp && cp.substring(0,2)==='75'; }

  function reverseGeocode(latlng){
    return new Promise((resolve) => {
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ location: latlng }, (results, status) => {
        if(status === 'OK' && results && results[0]) resolve(results[0].address_components);
        else resolve(null);
      });
    });
  }

  async function estimerPrix() {
    const depart = document.getElementById('autocomplete_depart').value.trim();
    const destination = document.getElementById('autocomplete_destination').value.trim();
    const prixEstime = document.getElementById('prixEstime');

    if (!depart || !destination) {
      prixEstime.textContent = "Veuillez saisir les lieux de départ et de destination.";
      prixEstime.style.display = "block";
      verifierFormulaire();
      return;
    }

    const directionsService = new google.maps.DirectionsService();
    directionsService.route({
      origin: depart,
      destination: destination,
      travelMode: google.maps.TravelMode.DRIVING,
    }, async (response, status) => {
      if (status === 'OK') {
        const leg = response.routes[0].legs[0];
        const distanceEnKm = leg.distance.value / 1000;

        const [compStart, compEnd] = await Promise.all([
          reverseGeocode(leg.start_location),
          reverseGeocode(leg.end_location)
        ]);

        const cpStart = cpFromComponents(compStart);
        const cpEnd   = cpFromComponents(compEnd);

        let inIDFStart = isInIDFFromCP(cpStart);
        let inIDFEnd   = isInIDFFromCP(cpEnd);
        if (inIDFStart === null) inIDFStart = inBbox(leg.start_location);
        if (inIDFEnd   === null) inIDFEnd   = inBbox(leg.end_location);

        if(!(inIDFStart && inIDFEnd)){
          prixEstime.textContent = "❌ Hors zone : nous couvrons uniquement l’Île-de-France.";
          prixEstime.style.display = "block";
          document.getElementById('btn-reserver').disabled = true;
          return verifierFormulaire();
        }

        const parisStart = isParisFromCP(cpStart);
        const parisEnd   = isParisFromCP(cpEnd);

        let prixTotal;
        if (parisStart && parisEnd) {
          prixTotal = 30; // forfait Paris->Paris
        } else {
          prixTotal = distanceEnKm < 4 ? 10 : distanceEnKm * 2.5;
        }
        if (pmrActif) prixTotal += 10;

        prixEstime.textContent = `Distance : ${distanceEnKm.toFixed(1)} km | Prix : ${prixTotal.toFixed(2)} €` + (pmrActif ? " (incl. PMR +10€)" : "");
        prixEstime.style.display = "block";
      } else {
        prixEstime.textContent = "Erreur lors du calcul.";
        prixEstime.style.display = "block";
      }
      verifierFormulaire();
    });
  }

  function missingFields(){
    const fields = [
      {el: document.getElementById('autocomplete_depart')},
      {el: document.getElementById('autocomplete_destination')},
      {el: document.getElementById('date')},
      {el: document.getElementById('heure')},
      {el: document.getElementById('telephone')},
    ];
    return fields.filter(f => !f.el.value.trim());
  }

  function flashMissing(){
    const btn = document.getElementById('btn-reserver');
    btn.classList.add('shake');
    const misses = missingFields();
    misses.forEach(f => f.el.classList.add('invalid'));
    const first = misses[0]?.el;
    if (first) first.scrollIntoView({behavior:'smooth', block:'center'});
    setTimeout(()=>{ btn.classList.remove('shake'); misses.forEach(f => f.el.classList.remove('invalid')); }, 900);
  }

  function verifierFormulaire() {
    const depart = document.getElementById('autocomplete_depart').value.trim();
    const destination = document.getElementById('autocomplete_destination').value.trim();
    const date = document.getElementById('date').value;
    const heure = document.getElementById('heure').value;
    const telephone = document.getElementById('telephone').value.trim();
    const prixEstimeText = document.getElementById('prixEstime').textContent;

    const okPrix = prixEstimeText.includes("Prix") && !prixEstimeText.includes("Hors zone");
    const formulaireComplet = depart && destination && date && heure && telephone && okPrix;
    const btnReserver = document.getElementById('btn-reserver');

    btnReserver.disabled = !formulaireComplet;
    btnReserver.setAttribute('aria-disabled', !formulaireComplet);
  }

  function formatDateFR(isoDate) {
    try {
      const d = new Date(isoDate + "T00:00:00");
      return d.toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    } catch(e) { return isoDate; }
  }

  window.addEventListener('load', () => {
    emailjs.init("yx7ldLiDmVC_uNq1N");
    initAutocomplete();

    ['autocomplete_depart', 'autocomplete_destination'].forEach(id => {
      document.getElementById(id).addEventListener('input', estimerPrix);
    });
    ['autocomplete_depart','autocomplete_destination','telephone','date','heure'].forEach(id => {
      document.getElementById(id).addEventListener('input', verifierFormulaire);
      document.getElementById(id).addEventListener('change', verifierFormulaire);
    });

    document.querySelectorAll('.preset-btn').forEach(btn => {
      btn.addEventListener('click', (event) => {
        const adresse = event.currentTarget.getAttribute('data-adresse');
        const inputId = event.currentTarget.getAttribute('data-input');
        document.getElementById(inputId).value = adresse;
        estimerPrix();
        verifierFormulaire();
      });
    });

    let nombrePersonnes = 1;
    const affichagePersonnes = document.getElementById('nombre-personnes');

    document.getElementById('btn-moins').addEventListener('click', () => {
      if (nombrePersonnes > 1) { nombrePersonnes--; affichagePersonnes.textContent = nombrePersonnes; }
    });
    document.getElementById('btn-plus').addEventListener('click', () => {
      if (nombrePersonnes < 9) { nombrePersonnes++; affichagePersonnes.textContent = nombrePersonnes; }
    });

    // PMR toggle
    const pmrBtn = document.getElementById('pmr-btn');
    pmrBtn.addEventListener('click', () => {
      pmrActif = !pmrActif;
      pmrBtn.classList.toggle('active', pmrActif);
      pmrBtn.setAttribute('aria-pressed', String(pmrActif));
      estimerPrix();
    });

    // Guard: clic sur bouton désactivé => feedback visuel
    document.getElementById('btn-guard').addEventListener('click', () => {
      if (document.getElementById('btn-reserver').disabled) {
        flashMissing();
      }
    });

    document.getElementById('btn-reserver').addEventListener('click', async () => {
      const btn = document.getElementById('btn-reserver');
      btn.disabled = true;
      btn.textContent = "Envoi en cours...";

      const prixEstimeText = document.getElementById('prixEstime').textContent;
      const prixCapture = (prixEstimeText.match(/Prix\s*:\s*([\d.,]+)/) || [null, ""])[1];

      const reservationData = {
        lieu_depart: document.getElementById('autocomplete_depart').value,
        lieu_arrivee: document.getElementById('autocomplete_destination').value,
        date: document.getElementById('date').value,
        heure: document.getElementById('heure').value,
        telephone: document.getElementById('telephone').value,
        prix: prixEstimeText,
        nombre_personnes: document.getElementById('nombre-personnes')?.textContent || '1',
        pmr: pmrActif ? "oui" : "non"
      };

      try {
        await emailjs.send("service_8m9y4b7", "template_jjf7ayv", reservationData);

        const recapHtml = `
          <div><b>Départ :</b> ${reservationData.lieu_depart}</div>
          <div><b>Destination :</b> ${reservationData.lieu_arrivee}</div>
          <div><b>Date :</b> ${formatDateFR(reservationData.date)}</div>
          <div><b>Heure :</b> ${reservationData.heure}</div>
          <div><b>Téléphone :</b> ${reservationData.telephone}</div>
          <div><b>Personnes :</b> ${reservationData.nombre_personnes}</div>
          <div><b>Option PMR :</b> ${reservationData.pmr}</div>
          <div><b>Tarif estimé :</b> ${prixCapture ? prixCapture.replace('.', ',') + ' €' : reservationData.prix}</div>
        `;
        document.getElementById('recapitulatif').innerHTML = recapHtml;
        document.getElementById('app').style.display = 'none';
        document.getElementById('confirmation').style.display = 'block';

      } catch (err) {
        alert("❌ Erreur lors de l'envoi de l'email. Merci de réessayer.");
        console.error(err);
        btn.disabled = false;
        btn.textContent = "RÉSERVER";
      }
    });

    verifierFormulaire();  // init
  });
</script>

</body>
</html>
